{% extends "layout.html" %}
{% block title %}{{ title }}{% endblock %}

{% block content %}

<style>
    .nav-pills .nav-item .nav-link {
        background-color: var(--bs-light);
        color: var(--bs-success);
    }
    .nav-pills .nav-item .nav-link.active {
        background-color: var(--bs-success);
        color: var(--bs-light);
    }
    p {
        margin-bottom: 0px;
    }
</style>

<div class="container mb-3">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/">Home</a></li>
            <li class="breadcrumb-item"><a
                    href="/configuracion">Configuracion</a></li>
            <li class="breadcrumb-item active"
                aria-current="page">{{title}}</li>
        </ol>
    </nav>
</div>

<hr>

<div class="container mx-auto">
    <div class="d-grid gap-1 d-md-flex justify-content-md-end">
        <button type="button" class="btn btn-outline-primary btn-sm"
            data-bs-toggle="modal"
            data-bs-target="#polygonModal">
            Ver todos los Lotes
        </button>
        <button type="button" class="btn btn-outline-success btn-sm"
            data-bs-toggle="modal"
            data-bs-target="#newEstablecimientoModal">Nuevo
            Establecimiento</button>
    </div>
</div>

<hr>

<div class="container mx-auto">
    <ul class="nav nav-pills nav-fill mb-3" id="pills-tab" role="tablist">
        {% for e in params.establishment %}
        <li class="nav-item" role="presentation">
            <button class="nav-link {% if loop.index ==1 %}active{% endif %}"
                id="{{e.id}}-tab"
                data-bs-toggle="pill" data-bs-target="#{{e.id}}"
                type="button" role="tab" aria-controls="{{e.id}}"
                aria-selected="false">{{e.name}}</button>
        </li>
        {% endfor %}
    </ul>
</div>

<hr>

<div class="tab-content" id="pills-tabContent">
    {% for e in params.establishment %}
    <div class="tab-pane fade {% if loop.index ==1 %}show active{% endif %}"
        id="{{e.id}}" role="tabpanel"
        aria-labelledby="{{e.id}}-tab" tabindex="0">

        <div class="col-12 mb-4" name="establecimiento">
            <div class="container text-center"
                {% if e.status == 'inactive' %}
                style="background-color: lightgray;"
                {% endif %}>
                <h3><small
                        style="font-weight: 400;">Establecimiento:
                    </small>{{e.name}}
                    {% if e.campos|length > 0 and e.status=='active' %}
                    {% endif %}
                </h3>
                <ul class="list-group mb-3">
                    <li class="list-group-item">Campos: {{e.campos|length}}</li>
                    <li class="list-group-item">Hectareas: {{e.hasAcum}}</li>
                    <li class="list-group-item">Creation Date:
                        {{e.creationDate}}</li>
                    <li class="list-group-item">Last Update Date:
                        {{e.lastUpdateDate}}</li>
                </ul>
                {% if e.status == 'active' %}
                <button class="btn btn-outline-success btn-sm my-1"
                    type="button"
                    data-bs-toggle="modal"
                    data-bs-target="#newCampoModal"
                    onclick='newCampo({{e|tojson|safe}})'>Nuevo
                    Campo</button>
                <button class="btn btn-outline-primary btn-sm my-1"
                    type="button"
                    data-bs-toggle="modal"
                    data-bs-target="#updateEstablecimientoModal"
                    onclick='updateEstablecimiento({{e|tojson|safe}})'>Editar
                    Estab.</button>
                <button class="btn btn-outline-danger btn-sm my-1"
                    type="button"
                    data-bs-toggle="modal"
                    data-bs-target="#deactivateEstablecimientoModal"
                    onclick='deactivateEstablecimiento({{e|tojson|safe}})'>Desactivar
                    Estab.</button>
                {% else %}
                <button class="btn btn-outline-success btn-sm my-1"
                    type="button"
                    data-bs-toggle="modal"
                    data-bs-target="#activateEstablecimientoModal"
                    onclick='activateEstablecimiento({{e|tojson|safe}})'>Activar
                    Estab.</button>
                {% endif %}

                {% if e.status == 'active' %}
                <hr>
                {% for c in e.campos %}
                <div class="container my-4 mx-0" name="campo">
                    <div class="card text-center shadow">
                        <div class="card-body"
                            {% if c.status == 'inactive' %}
                            style="background-color: lightgray;"
                            {% endif %}>
                            <h4 class="card-title"><small
                                    style="font-weight: 400;">Campo:
                                </small>{{c.name}}</h4>
                            <p><small>Hectareas:
                                </small>{{c.hasAcum}}</p>
                            {% if c.status =='active' %}
                            <button
                                class="btn btn-outline-success btn-sm my-1"
                                type="button"
                                data-bs-toggle="modal"
                                data-bs-target="#loteModal"
                                onclick='newLote({{e|tojson|safe}},{{c|tojson|safe}})'>Nuevo
                                Lote</button>
                            <button
                                class="btn btn-outline-primary btn-sm my-1"
                                type="button"
                                data-bs-toggle="modal"
                                data-bs-target="#updateCampoModal"
                                onclick='updateCampo({{e|tojson|safe}},{{c|tojson|safe}})'>Editar
                                Campo</button>
                            <button
                                class="btn btn-outline-danger btn-sm my-1"
                                type="button"
                                data-bs-toggle="modal"
                                data-bs-target="#deactivateCampoModal"
                                onclick='deactivateCampo({{e|tojson|safe}},{{c|tojson|safe}})'>Desactivar
                                Campo</button>
                            {% else %}
                            <button
                                class="btn btn-outline-success btn-sm my-1"
                                type="button"
                                data-bs-toggle="modal"
                                data-bs-target="#activateCampoModal"
                                onclick='activateCampo({{e|tojson|safe}},{{c|tojson|safe}})'>Activar
                                Campo</button>
                            {% endif %}

                            {% if c.status == 'active' %}
                            {% for l in c.lotes %}
                            <div class="container mt-2" name="lote">
                                <div class="card">
                                    <div class="card-body"
                                        {% if l.status == 'inactive'
                                        %}
                                        style="background-color: lightgray;"
                                        {% endif %}>
                                        <h5
                                            class="card-title"><small
                                                style="font-weight: 400;">Lote:
                                            </small>{{l.name}}</h5>
                                        {% if l.status == 'active' %}
                                        <p><small>Hectareas:
                                            </small>{{l.area}}</p>
                                        <div class="btn-group" role="group"
                                            aria-label="Basic mixed styles example">
                                            <button
                                                class="btn btn-primary btn-sm"
                                                type="button"
                                                data-bs-toggle="modal"
                                                data-bs-target="#loteModal"
                                                onclick='updateLote("update",{{e|tojson|safe}},{{c|tojson|safe}},{{l|tojson|safe}})'>Editar
                                                Lote</button>
                                            <button
                                                class="btn btn-danger btn-sm"
                                                type="button"
                                                data-bs-toggle="modal"
                                                data-bs-target="#loteModal"
                                                onclick='updateLote("deactivate",{{e|tojson|safe}},{{c|tojson|safe}},{{l|tojson|safe}})'>Desactivar
                                                Lote</button>
                                            {% else %}
                                            <button
                                                class="btn btn-success btn-sm"
                                                type="button"
                                                data-bs-toggle="modal"
                                                data-bs-target="#loteModal"
                                                onclick='updateLote("activate",{{e|tojson|safe}},{{c|tojson|safe}},{{l|tojson|safe}})'>Activar
                                                Lote</button>
                                            {% endif %}
                                            <button
                                                class="btn btn-secondary btn-sm"
                                                type="button"
                                                data-bs-toggle="modal"
                                                data-bs-target="#loteModal"
                                                onclick='updateLote("delete",{{e|tojson|safe}},{{c|tojson|safe}},{{l|tojson|safe}})'><i
                                                    class="fa-solid fa-trash"></i></button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                            {% endif %}
                            <!-- Closing Lote -->

                        </div>

                    </div>
                </div>
                {% endfor %}
                {% endif %}
                <!-- Closing Campo -->

            </div>
        </div>
    </div>
    {% endfor %}
    <!-- Closing Establecimiento -->
</div>

<!-- newEstablecimientoModal -->
<div class="modal fade" id="newEstablecimientoModal" tabindex="-1"
    aria-labelledby="newEstablecimientoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5"
                    id="newEstablecimientoModalLabel">Nuevo Establecimiento</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <form method="POST">
                <input type="hidden" name="action" value="newEstablecimiento">
                <div class="modal-body">
                    <div class="form-floating mb-1">
                        <input type="text" class="form-control" name="id"
                            id="id" readonly>
                        <label for="floatingInput">ID</label>
                    </div>
                    <div class="form-floating mb-1">
                        <input type="text" class="form-control" name="name"
                            placeholder="La Josefina">
                        <label for="floatingInput">Nombre</label>
                    </div>
                    <div class="form-floating mb-1">
                        <input type="text" class="form-control" name="status"
                            value="active" readonly>
                        <label for="floatingInput">Status</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary"
                        data-bs-dismiss="modal">Cerrar</button>
                    <button type="submit"
                        class="btn btn-success">Guardar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- newCampoModal -->
<div class="modal fade" id="newCampoModal" tabindex="-1"
    aria-labelledby="newCampoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="newCampoModalLabel">Nuevo
                    Campo</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <form method="POST" action="/configuracion/campo">
                <input type="hidden" name="action" value="newCampo">

                <div class="modal-body">
                    <input id="newCampoEstablecimientoId" type="hidden"
                        name="campoEstablecimientoId">

                    <div class="form-floating mb-1">
                        <input type="text" class="form-control" name="idCampo"
                            id="idCampo" readonly>
                        <label for="floatingInput">ID</label>
                    </div>
                    <div class="form-floating mb-1">
                        <input type="text" class="form-control"
                            name="nameCampo">
                        <label for="floatingInput">Nombre</label>
                    </div>
                    <div class="form-floating mb-1">
                        <input type="text" class="form-control"
                            name="statusCampo"
                            value="active" readonly>
                        <label for="floatingInput">Status</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary"
                        data-bs-dismiss="modal">Cerrar</button>
                    <button type="submit"
                        class="btn btn-success">Guardar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- updateEstablecimientoModal -->
<div class="modal fade" id="updateEstablecimientoModal" tabindex="-1"
    aria-labelledby="updateEstablecimientoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5"
                    id="updateEstablecimientoModalLabel">Editar
                    Establecimiento</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <form method="POST">
                <input type="hidden" name="action"
                    value="updateEstablecimiento">
                <div class="modal-body">
                    <div class="form-floating mb-1">
                        <input type="text" class="form-control" name="id"
                            id="updateId" readonly>
                        <label for="floatingInput">ID</label>
                    </div>
                    <div class="form-floating mb-1">
                        <input type="text" class="form-control" name="name"
                            id="updateName">
                        <label for="floatingInput">Nombre</label>
                    </div>
                    <div class="form-floating mb-1">
                        <input type="text" class="form-control" name="status"
                            id="updateStatus" readonly
                            value="active">
                        <label for="floatingInput">Status</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary"
                        data-bs-dismiss="modal">Cerrar</button>
                    <button type="submit"
                        class="btn btn-primary">Guardar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- updateCampoModal -->
<div class="modal fade" id="updateCampoModal" tabindex="-1"
    aria-labelledby="updateCampoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5"
                    id="updateCampoModalLabel">Editar Campo</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <form method="POST" action="/configuracion/campo">
                <input type="hidden" name="action" value="updateCampo">
                <div class="modal-body">
                    <input id="updateCampoEstablecimientoId" type="hidden"
                        name="campoEstablecimientoId">

                    <div class="form-floating mb-1">
                        <input type="text" class="form-control" name="idCampo"
                            id="updateCampoId" readonly>
                        <label for="floatingInput">ID</label>
                    </div>
                    <div class="form-floating mb-1">
                        <input type="text" class="form-control" name="nameCampo"
                            id="updateCampoName">
                        <label for="floatingInput">Nombre</label>
                    </div>
                    <div class="form-floating mb-1">
                        <input type="text" class="form-control"
                            name="statusCampo"
                            id="updateCampoStatus" readonly
                            value="active">
                        <label for="floatingInput">Status</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary"
                        data-bs-dismiss="modal">Cerrar</button>
                    <button type="submit"
                        class="btn btn-primary">Guardar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- deactivateEstablecimientoModal -->
<div class="modal fade" id="deactivateEstablecimientoModal" tabindex="-1"
    aria-labelledby="deactivateEstablecimientoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5"
                    id="deactivateEstablecimientoModalLabel">Desactivar
                    Establecimiento</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <form method="POST">
                <input type="hidden" name="action"
                    value="deactivateEstablecimiento">
                <div class="modal-body">
                    <div class="form-floating mb-1">
                        <input type="text" class="form-control" name="id"
                            id="deactivateId" readonly>
                        <label for="floatingInput">ID</label>
                    </div>
                    <div class="form-floating mb-1">
                        <input type="text" class="form-control" name="name"
                            id="deactivateName" readonly>
                        <label for="floatingInput">Nombre</label>
                    </div>
                    <div class="form-floating mb-1">
                        <input type="text" class="form-control" name="status"
                            id="deactivateStatus" readonly>
                        <label for="floatingInput">Status</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary"
                        data-bs-dismiss="modal">Cerrar</button>
                    <button type="submit"
                        class="btn btn-danger">Desactivar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- deactivateCampoModal -->
<div class="modal fade" id="deactivateCampoModal" tabindex="-1"
    aria-labelledby="deactivateCampoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5"
                    id="deactivateCampoModalLabel">Desactivar Campo</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <form method="POST" action="/configuracion/campo">
                <input type="hidden" name="action"
                    value="deactivateCampo">
                <div class="modal-body">
                    <input id="deactivateCampoEstablecimientoId" type="hidden"
                        name="campoEstablecimientoId">
                    <div class="form-floating mb-1">
                        <input type="text" class="form-control" name="idCampo"
                            id="deactivateCampoId" readonly>
                        <label for="floatingInput">ID</label>
                    </div>
                    <div class="form-floating mb-1">
                        <input type="text" class="form-control" name="nameCampo"
                            id="deactivateCampoName" readonly>
                        <label for="floatingInput">Nombre</label>
                    </div>
                    <div class="form-floating mb-1">
                        <input type="text" class="form-control"
                            name="statusCampo"
                            id="deactivateCampoStatus" readonly>
                        <label for="floatingInput">Status</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary"
                        data-bs-dismiss="modal">Cerrar</button>
                    <button type="submit"
                        class="btn btn-danger">Desactivar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- activateEstablecimientoModal -->
<div class="modal fade" id="activateEstablecimientoModal" tabindex="-1"
    aria-labelledby="activateEstablecimientoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5"
                    id="activateEstablecimientoModalLabel">Activar
                    Establecimiento</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <form method="POST">
                <input type="hidden" name="action"
                    value="activateEstablecimiento">
                <div class="modal-body">
                    <div class="form-floating mb-1">
                        <input type="text" class="form-control" name="id"
                            id="activateId" readonly>
                        <label for="floatingInput">ID</label>
                    </div>
                    <div class="form-floating mb-1">
                        <input type="text" class="form-control" name="name"
                            id="activateName" readonly>
                        <label for="floatingInput">Nombre</label>
                    </div>
                    <div class="form-floating mb-1">
                        <input type="text" class="form-control" name="status"
                            id="activateStatus" readonly>
                        <label for="floatingInput">Status</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary"
                        data-bs-dismiss="modal">Cerrar</button>
                    <button type="submit"
                        class="btn btn-success">Activar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- activateCampoModal -->
<div class="modal fade" id="activateCampoModal" tabindex="-1"
    aria-labelledby="activateCampoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5"
                    id="activateCampoModalLabel">Activar Campo</h1>
                <button type="button" class="btn-closse" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <form method="POST" action="/configuracion/campo">
                <input type="hidden" name="action"
                    value="activateCampo">
                <div class="modal-body">
                    <input id="activateCampoEstablecimientoId" type="hidden"
                        name="campoEstablecimientoId">
                    <div class="form-floating mb-1">
                        <input type="text" class="form-control" name="idCampo"
                            id="activateCampoId" readonly>
                        <label for="floatingInput">ID</label>
                    </div>
                    <div class="form-floating mb-1">
                        <input type="text" class="form-control" name="nameCampo"
                            id="activateCampoName" readonly>
                        <label for="floatingInput">Nombre</label>
                    </div>
                    <div class="form-floating mb-1">
                        <input type="text" class="form-control"
                            name="statusCampo"
                            id="activateCampoStatus" readonly>
                        <label for="floatingInput">Status</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary"
                        data-bs-dismiss="modal">Cerrar</button>
                    <button type="submit"
                        class="btn btn-success">Activar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- updateCampoModal -->
<div class="modal fade" id="updateCampoModal" tabindex="-1"
    aria-labelledby="updateCampoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5"
                    id="updateCampoModalLabel">Editar Campo</h1>
                <button type="button" class="btn-closse" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <form method="POST" action="/configuracion/campo">
                <input type="hidden" name="action"
                    value="updateCampo">
                <div class="modal-body">
                    <input id="updateCampoEstablecimientoId" type="hidden"
                        name="campoEstablecimientoId">
                    <div class="form-floating mb-1">
                        <input type="text" class="form-control" name="idCampo"
                            id="updateCampoId" readonly>
                        <label for="floatingInput">ID</label>
                    </div>
                    <div class="form-floating mb-1">
                        <input type="text" class="form-control" name="nameCampo"
                            id="updateCampoName">
                        <label for="floatingInput">Nombre</label>
                    </div>
                    <div class="form-floating mb-1">
                        <input type="text" class="form-control"
                            name="statusCampo"
                            id="updateCampoStatus" readonly>
                        <label for="floatingInput">Status</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary"
                        data-bs-dismiss="modal">Cerrar</button>
                    <button type="submit"
                        class="btn btn-success">Activar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- loteModal -->
<div class="modal fade" id="loteModal" tabindex="-1"
    aria-labelledby="loteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="loteModalLabel">Lote</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <form method="POST" action="/configuracion/lote">
                <input type="hidden" id="actionLote" name="action">
                <input type="hidden" id="loteEstablecimientoId"
                    name="loteEstablecimientoId">
                <input type="hidden" id="loteCampoId" name="loteCampoId">

                <div class="modal-body">

                    <div class="form-floating mb-1">
                        <input type="text" class="form-control"
                            name="idLote" id="idLote" readonly>
                        <label for="floatingInput">ID</label>
                    </div>
                    <div class="form-floating mb-1">
                        <input type="text" class="form-control"
                            name="nameLote" id="nameLote">
                        <label for="floatingInput">Nombre</label>
                    </div>

                    <div class="input-group mb-1">
                        <button type="button" class="btn btn-warning"
                            id="drawLoteButton"
                            data-bs-toggle="modal"
                            data-bs-target="#drawLoteModal">Dibujar
                            Lote</button>
                        <input type="hidden" name="geojson" id="geojson">
                        <div class="form-floating">
                            <input type="text" class="form-control"
                                id="area" name="area" required readonly>
                            <label for="floatingInput">Hectareas</label>
                        </div>
                    </div>

                    <div class="form-floating mb-1">
                        <input type="text" class="form-control"
                            name="statusLote" id="statusLote" readonly>
                        <label for="floatingInput">Status</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary"
                        data-bs-dismiss="modal">Cerrar</button>
                    <button type="submit"
                        class="btn" id="loteSubmitButton">Guardar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Draw Polygon -->
<div class="modal fade" id="drawLoteModal" tabindex="-1"
    aria-labelledby="drawLoteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog modal-fullscreen">
        <div class="modal-content">
            <div class="modal-header">Dibujar Lote
            </div>
            <div class="modal-body p-0">
                <div id="map" style="height: 100%;"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary"
                    data-bs-target="#loteModal"
                    data-bs-toggle="modal">Cancelar</button>
                <button type="button"
                    data-bs-target="#loteModal"
                    data-bs-toggle="modal"
                    class="btn btn-success"
                    id="loteSubmitButton">Guardar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Render All Polygons -->
<div class="modal fade" id="polygonModal" tabindex="-1"
    aria-labelledby="polygonModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog modal-fullscreen">
        <div class="modal-content">
            <div class="modal-header">Ver Lotes</div>
            <div class="modal-body p-0">
                <div id="mapAll" style="height: 100%"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary"
                    data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<hr>

<script>
    const params = {{ params|tojson }}
    console.log(params)

    // const arrayOfObjects = params.establishment;
    // const maxId = arrayOfObjects.reduce((max, obj) => (obj.id > max ? obj.id : max), -Infinity);
    // document.getElementById('id').value = parseInt(maxId)+1;
    document.getElementById('id').value = generateId(null)

    // TODO: simplify logic update/deactivate/activate while sanitizing input from user.
    // TODO: avoid multiple modals. Implement (replicate) Lote logic to Campo and Establecimiento - DRY.

    function updateEstablecimiento(e){
        document.getElementById('updateId').value = e.id
        document.getElementById('updateName').value = e.name
        document.getElementById('updateStatus').value ='active'
    }
    
    function deactivateEstablecimiento(e){
        document.getElementById('deactivateId').value = e.id
        document.getElementById('deactivateName').value = e.name
        document.getElementById('deactivateStatus').value = 'inactive'
    }
    
    function activateEstablecimiento(e){
        document.getElementById('activateId').value = e.id
        document.getElementById('activateName').value = e.name
        document.getElementById('activateStatus').value = 'active'
    }    

    function newCampo(e){
        document.getElementById('newCampoEstablecimientoId').value = e.id
        document.getElementById('idCampo').value = generateId(e.id)
    }
    
    function updateCampo(e,c){
        document.getElementById('updateCampoEstablecimientoId').value = e.id
        document.getElementById('updateCampoId').value = c.id
        document.getElementById('updateCampoName').value = c.name
        document.getElementById('updateCampoStatus').value ='active'
    }

    function deactivateCampo(e,c){
        document.getElementById('deactivateCampoEstablecimientoId').value = e.id
        document.getElementById('deactivateCampoId').value = c.id
        document.getElementById('deactivateCampoName').value = c.name
        document.getElementById('deactivateCampoStatus').value ='inactive'
    }
    
    function activateCampo(e,c){
        document.getElementById('activateCampoEstablecimientoId').value = e.id
        document.getElementById('activateCampoId').value = c.id
        document.getElementById('activateCampoName').value = c.name
        document.getElementById('activateCampoStatus').value ='active'
    }

    
    function newLote(e,c){
        document.getElementById('actionLote').value = 'newLote'
        document.getElementById('loteEstablecimientoId').value = e.id
        document.getElementById('loteCampoId').value = c.id
        document.getElementById('idLote').value = generateId(e.id + '_' + c.id)
        document.getElementById('nameLote').value = ''
        document.getElementById('statusLote').value = 'active'
        document.getElementById('geojson').value = ''
        document.getElementById('area').value = ''
        document.getElementById('loteSubmitButton').classList.add('btn-success')
    }

    function updateLote(action, e,c,l){
        console.log('UPDATE LOTE: ',l)
        document.getElementById('actionLote').value = action
        document.getElementById('loteEstablecimientoId').value = e.id
        document.getElementById('loteCampoId').value = c.id
        document.getElementById('idLote').value = l.id
        document.getElementById('nameLote').value = l.name
        document.getElementById('geojson').value = JSON.stringify(l.geojson)
        document.getElementById('area').value = l.area
        document.getElementById('loteSubmitButton').className = "btn"
        switch (action){
            case 'deactivate':
            document.getElementById('drawLoteButton').disabled = true;
            document.getElementById('statusLote').value = 'inactive'
            document.getElementById('loteSubmitButton').classList.add('btn-danger')
            break;
            case 'activate':
            document.getElementById('drawLoteButton').disabled = true;
            document.getElementById('statusLote').value = 'active'
            document.getElementById('loteSubmitButton').classList.add('btn-success')
            break;
            case 'update':
            document.getElementById('drawLoteButton').disabled = false;
            document.getElementById('statusLote').value = 'active'
            document.getElementById('loteSubmitButton').classList.add('btn-primary')
            break;
            case 'delete':
            document.getElementById('drawLoteButton').disabled = true;
            document.getElementById('statusLote').value = 'active'
            document.getElementById('loteSubmitButton').classList.add('btn-danger')
            break;
        }
    }

    function generateId(prefix) {
        var currentDate = new Date().toISOString().slice(0,10).replace(/-/g,"");
        var randomString1 = Array.from({length: 3}, () => Math.random().toString(36)[2]).join('');
        var randomString2 = Array.from({length: 3}, () => Math.random().toString(36)[2]).join('');
        var newId = `${currentDate}_${randomString1}-${randomString2}`;
        if (prefix) {
            newId = `${prefix}_${newId}`;
        }
        return newId;
    }


    // LEAFLET - MAP FUNCTIONALITY
    var map;
    var drawnItems = new L.FeatureGroup(); // Initialize a feature group for drawn items

    document.getElementById('drawLoteModal').addEventListener('shown.bs.modal', () => {
        if (map) {
            map.remove();
        }
        map = L.map('map').setView([-32.84478543873638, -61.11837708005918], 13);
        //map = L.map('map')
        var openStreetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        });
        var openTopoLayer = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
            maxZoom: 17,
            attribution: 'Map data: &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, <a href="http://viewfinderpanoramas.org">SRTM</a> | Map style: &copy; <a href="https://opentopomap.org">OpenTopoMap</a> (<a href="https://creativecommons.org/licenses/by-sa/3.0/">CC-BY-SA</a>)'
        });
        var satelliteGoogleLayer = L.tileLayer('http://{s}.google.com/vt?lyrs=s&x={x}&y={y}&z={z}',{
            maxZoom: 20,
            subdomains:['mt0','mt1','mt2','mt3']
        });
        satelliteGoogleLayer.addTo(map); // Default layer
        
        // Create a layer control object and add it to the map
        var baseLayers = {
            "Satellite": satelliteGoogleLayer
            ,"Street Map": openStreetLayer
            ,"OpenTopoMap": openTopoLayer
        };
        L.control.layers(baseLayers).addTo(map);
        
        var drawnItems = new L.FeatureGroup();
        map.addLayer(drawnItems);
        
        var drawControl = new L.Control.Draw({
            draw: {
            polygon: true,
            polyline: false,
            rectangle: false,
            circle: false,
            marker: false,
            circlemarker:false
            },
            edit: {
                featureGroup: drawnItems
            }
        });
        map.addControl(drawControl);

        var actionSelected = document.getElementById('actionLote').value
        var loteCampoId = document.getElementById('loteCampoId').value
        if (actionSelected != 'newLote'){
            // Parse GeoJSON from the input variable and add polygon to the map
            var geojsonStr = document.getElementById('geojson').value;
            if (geojsonStr) {
                try {
                    var geojson = JSON.parse(geojsonStr);
                    var layer = L.geoJSON(geojson, {
                        onEachFeature: function (feature, layer) {
                            drawnItems.addLayer(layer);
                        }
                    }).addTo(map);
                    var bounds = layer.getBounds();
                    var center = bounds.getCenter();
                    map.setView(center, 13);
                } catch (error) {
                    console.error('Error parsing GeoJSON',error);
                }
            }
            // TODO: Programmatically enable edit functionality of the added layer
        } else {
            var polygonDrawer = new L.Draw.Polygon(map);
            polygonDrawer.enable();
            setCampoView(loteCampoId);
        }
       
        map.on(L.Draw.Event.CREATED, function(event) {
            var layer = event.layer;
            document.getElementById('geojson').value = JSON.stringify(layer.toGeoJSON());
            document.getElementById('area').value = calculatePolygonAreaInHectares(layer);
            drawnItems.addLayer(layer);
        });
    });

    function calculatePolygonAreaInHectares(polygon) {
        var area = L.GeometryUtil.geodesicArea(polygon.getLatLngs()[0]); 
        var areaInHectares = (area / 10000).toFixed(2); 
        return areaInHectares;
    }
    


    function setCampoView(selectedCampoId){
        // Set the view to nearby area
        var lotesFound = false;
        var bounds = L.latLngBounds();
        params.establishment.forEach(e => {
            e.campos.forEach(campo => {
                if(campo.id===selectedCampoId){
                    if(campo.lotes){
                        campo.lotes.forEach(lote => {
                            var layer = L.geoJSON(lote.geojson,{
                                onEachFeature: function (feature,layer){
                                    bounds.extend(layer.getBounds());
                                    lotesFound = true
                                }
                            })
                        })
                    }
                }
            })
        })
        if(lotesFound){
            map.fitBounds(bounds);
        }
    }

    var mapAll;

    // Function to render polygons in modal
    function renderPolygonsInModal(data) {
        // Remove existing map instance if it exists
        if (mapAll) {
            mapAll.remove();
        }

        // Create a new map instance
        mapAll = L.map('mapAll');
        var satelliteGoogleLayer = L.tileLayer('http://{s}.google.com/vt?lyrs=s&x={x}&y={y}&z={z}',{
            maxZoom: 20,
            subdomains:['mt0','mt1','mt2','mt3']
        });
        satelliteGoogleLayer.addTo(mapAll);
        var bounds = L.latLngBounds();

        // Iterate over each "establecimiento" in the data
        data.forEach(establecimiento => {
            establecimiento.campos.forEach(campo => {
                campo.lotes.forEach(lote => {
                    var label = `${lote.name} ${lote.area} has (Campo: ${campo.name})`
                    var layer = L.geoJSON(lote.geojson, {
                        onEachFeature: function (feature, layer) {
                            // Add the polygon to the map
                            drawnItems.addLayer(layer);
                            bounds.extend(layer.getBounds());
                        }
                    }).bindTooltip(label, { permanent: true, direction: "center" }).openTooltip().addTo(mapAll);
                });
            });
        });
        mapAll.fitBounds(bounds);
    }
    
    // Attach event listener to modal show event to render polygons
    document.getElementById('polygonModal').addEventListener('shown.bs.modal', () => {
        renderPolygonsInModal(params.establishment);
    });
    


</script>

{% endblock %}